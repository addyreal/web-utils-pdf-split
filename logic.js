const main=document.getElementById("main"),outputElement=document.getElementById("output"),pdf_input=document.getElementById("input"),preview_container=document.getElementById("preview_container"),preview_canvas=document.getElementById("preview_canvas"),_c_preview_view=document.getElementById("_c_preview_view"),_c_preview_hide=document.getElementById("_c_preview_hide"),_c_preview_wipe=document.getElementById("_c_preview_wipe"),_c_preview_reset=document.getElementById("_c_preview_reset"),_c_preview_delete=document.getElementById("_c_preview_delete"),_c_preview_rotate=document.getElementById("_c_preview_rotate"),config_container=document.getElementById("config_container"),multipage_help=document.getElementById("multipage_help"),multipage_prev=document.getElementById("multipage_prev"),multipage_next=document.getElementById("multipage_next"),multipage_count=document.getElementById("multipage_count"),action_button_trim=document.getElementById("action_button_trim"),action_button_split=document.getElementById("action_button_split");var filename="",fileBuffer=null,PDFDoc=null,num_pages=0,renderInProgress=!1;async function renderPDFPage(e){const t=await PDFDoc.getPage(e),n=t.getViewport({scale:CONST_DPI/72});canvas.width=n.width>=600?600:n.width,canvas.height=n.height>=600?600:n.height,vCanvas.width=n.width,vCanvas.height=n.height;const i=t.render({canvasContext:vContext,viewport:n});await i.promise}function getLineCount(e){return e.value.split("\n").length-1}function resizeOutput(e){e.style.height="calc(1.2rem * "+getLineCount(e)+" + 70px)"}function clearOutput(e){e.value=""}clearOutput(outputElement);const canvas=document.getElementById("canvas"),context=canvas.getContext("2d");context.imageSmoothingEnabled=!1;const vCanvas=document.createElement("canvas"),vContext=vCanvas.getContext("2d");vContext.imageSmoothingEnabled=!1;const CONST_DPI=144,CONST_ZOOMFACTOR=1.1,CONST_MOBILEZOOMFACTOR=1.05;function draw(){context.setTransform(1,0,0,1,0,0),context.clearRect(0,0,canvas.width,canvas.height),context.imageSmoothingEnabled=!1,context.setTransform(previewWindow.scale,0,0,previewWindow.scale,previewWindow.offsetX,previewWindow.offsetY),0!=userSelection.rotate[userSelection.current-1]&&(context.translate(vCanvas.width/2,vCanvas.height/2),context.rotate(userSelection.rotate[userSelection.current-1]*Math.PI/2),context.translate(-1*vCanvas.width/2,-1*vCanvas.height/2)),context.drawImage(vCanvas,0,0),0==userSelection.pages[userSelection.current-1]&&(context.setTransform(1,0,0,1,0,0),context.fillStyle="rgba(0, 0, 0, 0.7)",context.fillRect(0,0,canvas.width,canvas.height))}function press(e,t){const n=canvas.getBoundingClientRect();previewWindow.isDragging=!0,previewWindow.isTouchZooming=!1,previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top}function move(e,t){if(!previewWindow.isDragging||previewWindow.isTouchZooming)return;const n=canvas.getBoundingClientRect(),i=e-n.left-previewWindow.lastX,o=t-n.top-previewWindow.lastY;previewWindow.offsetX+=i,previewWindow.offsetY+=o,previewWindow.lastX=e-n.left,previewWindow.lastY=t-n.top,draw()}function zoom(e){const t=canvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,o=e.deltaY<=0?1.1:1/1.1,r=(n-previewWindow.offsetX)/previewWindow.scale,c=(i-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=o,previewWindow.offsetX=n-r*previewWindow.scale,previewWindow.offsetY=i-c*previewWindow.scale,draw()}function end(){previewWindow.isDragging=!1,canvas.classList.remove("grabbing")}function getTouchesDist(e,t){const n=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.hypot(n,i)}function getTouchesX(e,t){return(e.clientX+t.clientX)/2}function getTouchesY(e,t){return(e.clientY+t.clientY)/2}function mobileStartZoom(e,t){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!0,previewWindow.lastTouchesDist=getTouchesDist(e,t)}function mobileZoom(e,t){const n=canvas.getBoundingClientRect(),i=getTouchesX(e,t)-n.left,o=getTouchesY(e,t)-n.top,r=getTouchesDist(e,t)-previewWindow.lastTouchesDist<=0?1/1.05:1.05,c=(i-previewWindow.offsetX)/previewWindow.scale,a=(o-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=r,previewWindow.offsetX=i-c*previewWindow.scale,previewWindow.offsetY=o-a*previewWindow.scale,previewWindow.lastTouchesDist=getTouchesDist(e,t),draw()}function mobileEnd(){previewWindow.isDragging=!1,previewWindow.isTouchZooming=!1}var previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1};function resetPreviewWindow(){previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1}}var userSelection={current:1,total:1,pages:[0],rotate:[0]};function resetUserSelection(e){userSelection={current:1,total:e,pages:Array.from({length:e},(()=>1)),rotate:Array.from({length:e},(()=>0))}}function action(e){clearOutput(outputElement),resizeOutput(outputElement),(async()=>{const{PDFDocument:t}=PDFLib,n=await t.load(fileBuffer);for(let e=num_pages;e>=1;e--)if(0==userSelection.pages[e-1])n.removePage(e-1);else if(0!=userSelection.rotate[e-1]){n.getPages()[e-1].setRotation(PDFLib.degrees(90*userSelection.rotate[e-1]))}if(1==e){const e=n.getPageCount();if(0==e)return outputElement.value+="Aborting download of zero pages\n",void resizeOutput(outputElement);for(let i=1;i<=e;i++){const e=await t.create(),[o]=await e.copyPages(n,[i-1]);e.addPage(o);const r=await e.save(),c=new Blob([r],{type:"application/pdf"}),a=document.createElement("a");a.href=URL.createObjectURL(c),a.download=filename+`-page-${i}.pdf`,a.click(),URL.revokeObjectURL(a.href)}}else{const e=n.getPageCount();if(0==e)return outputElement.value+="Aborting download of zero pages\n",void resizeOutput(outputElement);if(e==userSelection.total){let e=!1;for(const t of userSelection.rotate)if(0!=t){e=!0;break}if(0==e)return outputElement.value+="Aborting download of unchanged document\n",void resizeOutput(outputElement)}newBytes=await n.save();const t=new Blob([newBytes],{type:"application/pdf"}),i=document.createElement("a");i.href=URL.createObjectURL(t),i.download=filename+"-trimmed.pdf",i.click(),URL.revokeObjectURL(i.href)}})()}pdfjsLib.GlobalWorkerOptions.workerSrc="pdf.worker.min.js",pdf_input.onchange=async e=>{clearOutput(outputElement),config_container.classList.add("hidden"),multipage_help.classList.add("hidden");const t=e.target.files[0];if(!t)return;filename=t.name.replace(/\.pdf$/i,"");const n=await t.arrayBuffer();fileBuffer=n.slice(0),PDFDoc=await pdfjsLib.getDocument({data:n}).promise,renderInProgress=!0,await renderPDFPage(1),renderInProgress=!1,resetPreviewWindow(),resetUserSelection(num_pages=PDFDoc.numPages),draw(),config_container.classList.remove("hidden"),num_pages>1&&(multipage_help.classList.remove("hidden"),multipage_count.innerHTML=userSelection.current+"/"+userSelection.total)},canvas.addEventListener("wheel",(e=>{e.preventDefault(),zoom(e)})),canvas.addEventListener("mousedown",(e=>{canvas.classList.add("grabbing"),press(e.clientX,e.clientY)})),canvas.addEventListener("mousemove",(e=>{e.preventDefault(),move(e.clientX,e.clientY)})),canvas.addEventListener("mouseup",(()=>{end()})),canvas.addEventListener("mouseleave",(()=>{end()})),canvas.addEventListener("touchstart",(function(e){e.preventDefault(),1==e.touches.length?press(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileStartZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchmove",(function(e){e.preventDefault(),1==e.touches.length?move(e.touches[0].clientX,e.touches[0].clientY):2==e.touches.length&&mobileZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchend",(()=>{mobileEnd()}),{passive:!1}),canvas.addEventListener("touchcancel",(()=>{mobileEnd()}),{passive:!1}),_c_preview_view.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_preview_wipe.addEventListener("click",(()=>{for(let e=1;e<=num_pages;e++)userSelection.pages[e-1]=0;draw()})),_c_preview_reset.addEventListener("click",(()=>{for(let e=1;e<=num_pages;e++)userSelection.pages[e-1]=1,userSelection.rotate[e-1]=0;draw()})),_c_preview_delete.addEventListener("click",(()=>{userSelection.pages[userSelection.current-1]=0==userSelection.pages[userSelection.current-1]?1:0,draw()})),_c_preview_rotate.addEventListener("click",(()=>{userSelection.rotate[userSelection.current-1]=(userSelection.rotate[userSelection.current-1]+1)%4,draw()})),_c_preview_hide.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),multipage_prev.addEventListener("click",(async function(){1==userSelection.current||renderInProgress||(renderInProgress=!0,userSelection.current-=1,await renderPDFPage(userSelection.current),draw(),multipage_count.innerHTML=userSelection.current+"/"+userSelection.total,renderInProgress=!1)})),multipage_next.addEventListener("click",(async function(){userSelection.current==userSelection.total||renderInProgress||(renderInProgress=!0,userSelection.current+=1,await renderPDFPage(userSelection.current),draw(),multipage_count.innerHTML=userSelection.current+"/"+userSelection.total,renderInProgress=!1)})),action_button_trim.addEventListener("click",(function(){action(!1)})),action_button_split.addEventListener("click",(function(){action(!0)}));